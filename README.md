# ربات فروشگاه زنجیره‌ای تلگرام

## قابلیت‌ها

### مدیریت کاربران
- ثبت‌نام و احراز هویت کاربران
- کنترل دسترسی مبتنی بر نقش (مدیر، فروشنده، مشتری)
- مدیریت پروفایل کاربران
- مدیریت وضعیت کاربران (فعال، مسدود، تعلیق)

### مدیریت محصولات
- لیست و دسته‌بندی محصولات
- عملیات CRUD محصولات
- مدیریت موجودی
- مدیریت قیمت
- پشتیبانی از تصاویر محصول
- نمایش محصولات بر اساس شهر

### مدیریت سفارشات
- سبد خرید
- ایجاد و پیگیری سفارشات
- به‌روزرسانی وضعیت سفارش
- تاریخچه سفارشات
- لغو سفارش

### سیستم پرداخت
- روش‌های پرداخت متعدد:
  - پرداخت با موجودی
  - پرداخت با ارز دیجیتال (TRC20)
- تأیید پرداخت
- تاریخچه تراکنش‌ها
- مدیریت موجودی

### مدیریت موقعیت مکانی
- مدیریت شهر و استان
- تنظیمات موقعیت کاربر
- مدیریت مناطق تحویل

### سیستم پشتیبانی
- پشتیبانی مبتنی بر تیکت
- رابط پشتیبانی ادمین
- رابط پشتیبانی کاربر

### ویژگی‌های امنیتی
- احراز هویت مبتنی بر JWT
- کنترل دسترسی مبتنی بر نقش
- اعتبارسنجی ورودی‌ها
- محدودیت نرخ درخواست
- پردازش امن پرداخت‌ها
- رمزنگاری داده‌ها
- مدیریت نشست
- احراز هویت پایگاه داده با auth_socket

### نظارت و ثبت رویدادها
- سیستم ثبت رویداد جامع
- ردیابی خطاها
- ثبت اقدامات کاربر
- ثبت اقدامات ادمین
- نظارت بر عملکرد

## معماری فنی

### اجزای اصلی
- **کلاینت تلگرام**: مدیریت ارتباط با API تلگرام
- **لایه پایگاه داده**: ORM SQLAlchemy با MySQL (با احراز هویت auth_socket)
- **لایه کش**: Redis برای مدیریت نشست و کش
- **لایه امنیتی**: احراز هویت JWT و رمزنگاری
- **لایه پرداخت**: پردازش پرداخت با ارز دیجیتال و موجودی

### ساختار پروژه
```
src/
├── bot/                 # پیاده‌سازی ربات
│   ├── handlers/        # مدیریت پیام‌ها و پاسخ‌ها
│   ├── common/          # ابزارهای مشترک ربات
│   └── roles/           # عملکردهای خاص نقش‌ها
├── core/                # منطق اصلی کسب‌وکار
│   ├── models/          # مدل‌های پایگاه داده
│   ├── services/        # سرویس‌های کسب‌وکار
│   └── exceptions/      # استثناهای سفارشی
├── config/              # مدیریت پیکربندی
├── integrations/        # یکپارچه‌سازی با سرویس‌های خارجی
├── utils/               # توابع کمکی
└── monitoring/          # نظارت و ثبت رویدادها
```

## اقدامات امنیتی

### احراز هویت و مجوز
- احراز هویت مبتنی بر توکن JWT
- کنترل دسترسی مبتنی بر نقش
- مدیریت نشست با Redis
- مکانیزم انقضا و تمدید توکن
- احراز هویت پایگاه داده با auth_socket

### حفاظت از داده‌ها
- رمزنگاری داده‌های حساس
- هش کردن رمز عبور
- اعتبارسنجی و پاکسازی ورودی‌ها
- پیشگیری از تزریق SQL
- محافظت در برابر XSS

### امنیت پرداخت
- تأیید امن پرداخت
- اعتبارسنجی تراکنش
- تشخیص تقلب
- رمزنگاری داده‌های پرداخت

### امنیت زیرساخت
- کانتینری‌سازی با Docker
- جداسازی شبکه
- پیکربندی امن پایگاه داده با auth_socket
- مدیریت متغیرهای محیطی

## راه‌اندازی و نصب

### پیش‌نیازها
- Python 3.12+
- MySQL 8.0+
- Redis
- Docker (اختیاری)

### راه‌اندازی محیط
1. کلون کردن مخزن
2. ایجاد و فعال‌سازی محیط مجازی:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Linux/Mac
   venv\Scripts\activate     # Windows
   ```
3. نصب وابستگی‌ها:
   ```bash
   pip install -r requirements.txt
   ```
4. کپی کردن `.env.example` به `.env` و پیکربندی:
   ```bash
   cp .env.example .env
   ```
5. به‌روزرسانی `.env` با اطلاعات اعتبار:
   - اطلاعات API تلگرام
   - اطلاعات پایگاه داده (بدون رمز عبور، با استفاده از auth_socket)
   - اطلاعات Redis
   - تنظیمات امنیتی

### Automated Database Setup
For automated database setup, you can use the `setup_database.py` script. This script automates all database setup steps and properly handles errors:

1. Using auth_socket (recommended):
   ```bash
   python scripts/setup_database.py --auth-socket
   ```

2. Using password authentication:
   ```bash
   python scripts/setup_database.py --password-auth
   ```

This script automatically:
- Creates the database
- Creates the required user
- Grants necessary permissions
- Updates the `.env` file with correct database settings
- Runs Alembic migrations

For help and additional options:
```bash
python scripts/setup_database.py --help
```

### Manual Database Setup (Legacy Method)
1. Create database with auth_socket authentication:
   ```bash
   mysql -u root -p < database_setup.sql
   ```
2. Run migrations:
   ```bash
   alembic upgrade head
   ```

### اجرای ربات
1. راه‌اندازی Redis:
   ```bash
   redis-server
   ```
2. راه‌اندازی ربات:
   ```bash
   python src/main.py
   ```

### استقرار با Docker
1. ساخت و راه‌اندازی کانتینرها:
   ```bash
   docker-compose up -d
   ```

## تست

### انواع تست
- تست واحد
- تست یکپارچه‌سازی
- تست end-to-end
- تست امنیتی
- تست عملکرد

### اجرای تست‌ها
1. ایجاد محیط تست:
   ```bash
   python -m venv venv_test
   source venv_test/bin/activate  # Linux/Mac
   venv_test\Scripts\activate     # Windows
   ```
2. نصب وابستگی‌های تست:
   ```bash
   pip install -r requirements.txt
   ```
3. اجرای تست‌ها:
   ```bash
   pytest
   ```

### پوشش تست
- تست واحد: عملکرد اصلی
- تست یکپارچه‌سازی: تعاملات اجزا
- تست E2E: جریان‌های کامل کاربر
- تست امنیتی: بررسی آسیب‌پذیری‌ها
- تست عملکرد: تست بار و استرس

## دستورالعمل‌های توسعه

### سبک کدنویسی
- پیروی از دستورالعمل‌های PEP 8
- استفاده از type hints
- مستندسازی تمام توابع و کلاس‌ها
- نوشتن تست‌های جامع

### گردش کار Git
1. ایجاد شاخه feature
2. اعمال تغییرات
3. اجرای تست‌ها
4. ایجاد pull request
5. بررسی کد
6. ادغام با main

### دستورالعمل‌های امنیتی
- عدم commit داده‌های حساس
- استفاده از متغیرهای محیطی
- پیروی از بهترین روش‌های امنیتی
- ممیزی امنیتی منظم
- استفاده از auth_socket برای احراز هویت پایگاه داده

## نظارت و نگهداری

### ثبت رویدادها
- ثبت رویدادهای برنامه در پوشه `logs/`
- ردیابی خطاها
- ثبت اقدامات کاربر
- ثبت اقدامات ادمین

### نظارت بر عملکرد
- ردیابی زمان پاسخ
- نظارت بر استفاده از منابع
- نظارت بر نرخ خطا
- ردیابی فعالیت کاربر

### پشتیبان‌گیری و بازیابی
- پشتیبان‌گیری منظم از پایگاه داده
- پشتیبان‌گیری از داده‌های نشست
- پشتیبان‌گیری از پیکربندی
- برنامه بازیابی پس از فاجعه

## پشتیبانی و تماس

برای پشتیبانی و سوالات:
- ایمیل: support@example.com
- تلگرام: @support_username

## مجوز
این پروژه تحت مجوز MIT منتشر شده است - برای جزئیات به فایل LICENSE مراجعه کنید.


